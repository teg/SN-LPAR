% Preempt some bad decisions by LLNCS
\RequirePackage{fixllncs}


\documentclass[orivec]{llncs}


% To get cases in equations
\usepackage{amsmath}

% To use definitions, lemmas and theorems.
%\usepackage{amsthm}

% twoheadleftarrow
\usepackage{amssymb}

% Nicer array and tabular layout (IEEE-suggested)
\usepackage{array}

% A more pleasant font
\usepackage[T1]{fontenc} % use postscript type 1 fonts
\usepackage{textcomp} % use symbols in TS1 encoding
%\usepackage[garamond]{mathdesign} % use a nice font

% A taste of french
%\usepackage[french]{babel}
\usepackage[utf8]{inputenc}

% Allow inclusion of graphics
%\usepackage[pdftex]{graphicx}

% To get url's
%\usepackage[hidelinks]{hyperref}

% Improves the text layout
\usepackage{microtype}

% For in-line lists
\usepackage{paralist}

% To typeset derivations
\usepackage[lutzsyntax,pdftex]{virginialake}

% Landscape-orientated floats
\usepackage{rotating}

% To get semantic brackets
\usepackage{stmaryrd}

% Don't remember what this does
\usepackage[normalem]{ulem}

\usepackage{proof}

% Nice fractions
\usepackage{units}

% For commands with multiple optional arguments
\usepackage{xargs}

% Our own stuff
\usepackage{ALmacros}
%\usepackage{includeFigure}
%\input{ALpictures}
\usepackage{willemtools}

% Get counters and fonts right for theorem environments
\spnewtheorem{ALtheorem}{Theorem}{\bfseries}{\itshape}
\spnewtheorem{ALdefinition}[ALtheorem]{Definition}{\bfseries}{\upshape}
\spnewtheorem{ALproposition}[ALtheorem]{Proposition}{\bfseries}{\itshape}
\spnewtheorem{ALlemma}[ALtheorem]{Lemma}{\bfseries}{\itshape}


\newif\ifnonotes\nonotesfalse
\newcommand{\EMPTY}[1]{\ifnonotes\else{\color{red}    \noindent #1}\fi}
\newcommand{\Comment}[1]{\ifnonotes\else{\color{red}    \noindent{\bf Comment: }#1}\fi}
\newcommand{\Remark}[1]{\ifnonotes\else{\color{red}    \noindent{\bf Remark: }#1}\fi}
\newcommand{\TODO}[1]{\ifnonotes\else{\color{red}    \noindent{\bf TODO }#1}\fi}
%\newcommand{\Rem}[1]{\ifnonotes\else{\color{red}    \bigskip\\{\bf Remark: }#1 \bigskip\\}\fi}
%\nonotestrue % If this is commented, notes appear in the paper (if any)
%---------------------------------------------------------- REMOVE WHEN FINISHED



\begin{document}

\begin{ALdefinition}
A type $A'$ is a \emph{replacement type} for $t:A$ if
\begin{itemize}
	\item $A=B\vlim C$, $t=\lambda x.u$, and $A'=B'\vlim C'$, while $B'=B$ or $x$ is weakened in $u$, and $C'$ is a replacement type for $u:C$; or
	\item $A=\bigcap_{i\leq n}A_i$ and $A'=\bigcap_{i\leq n}A'_i$ with $A'_i$ a replacement type for $t:A'_i$ for each $i\leq n$; or
	\item $A'=A$.
\end{itemize}
\end{ALdefinition}


In other words, a replacement type $A'$ for $t:A$ may differ from $A$ in the type of the weakened leading abstractions of $t$.


\noindent\textbf{Typing rules for $D_a$:}
\[
	\vliinf{}{}
	  {\Gamma \vdash u: A\cap B}
	  {\Gamma \vdash u: A}
	  {\Gamma \vdash u: B}
	\qquad
	\vlinf{}{}
	  {\Gamma \vdash u: A}
	  {\Gamma \vdash u: A\cap B}
	\qquad
	\vlinf{}{}
	  {\Gamma \vdash u: B}
	  {\Gamma \vdash u: A\cap B}
\]
\bigskip
\[
  \vliiinf{}{}
   {\Gamma, \Delta \vdash t^*\share*{\vv*x}u : A}
   {\Gamma, \vv*x : B' \vdash t^* : A}
   {}
   {\Delta \vdash u : B}
\]
\bigskip
\[
	\vliiinf{}{}
	  {\Gamma,\Delta \vdash u^*\distr xy{t^n}:A}
	  {\Gamma, (x_i:\bigcap_{j\leq m}(B'_j\vlim C^i_j))_{i\leq n} \vdash u^*:A}
	  {}
	  {(\Delta, y:B_j\vdash t^n : \vls(C_j^1.\dots.C_j^n))_{j\leq m}}
\]
Where in the central rule, $B'$ is a replacement type for $u:B$, and in the last rule, $B'_j=B_j$ or $y$ is weakened in $t^n$.



\newpage


\begin{ALlemma}[Draft]
Subject reduction for the distributor rewrite rules of $D_a$.
\end{ALlemma}

\begin{proof}
%
Rule~\eqref{eqn:share abstraction} (distributor introduction), before:
\[
\vlderivation{
  \vliiin{}{}
	{\vdash u\share*{\vv*x}{\lambda y.t}:C}
	{\vlhy{\vv*x:\bigcap_{j\leq m}(A'_j\vlim B'_j)\vdash u:C}}
	{\vlhy{}}
	{\vlin{}{}
	  {\vdash\lambda y.t:\bigcap_{j\leq m}(A_j\vlim B_j)}
	  {\vlhy{
	    \left(
		\vlinf{}{}
	 	  {\vdash\lambda y.t:A_j\vlim B_j}
		  {y:A_j\vdash t:B_j}
		\right)_{j\leq m}
	}}}
}
\]

\noindent
Rule~\eqref{eqn:share abstraction} (distributor introduction), after:
\[
  \vliiinf{}{}
	{u\distr*{\vv*x}y{\tup z\share zt}:C}
	{\raisebox{-25pt}{
		$\vv*x:\bigcap_{j\leq m}(A'_j\vlim B'_j)\vdash u:C$
	}}	
	{\vlhy{}}
	{\left(\vlderivation{
		\vliiin{}{}
	 	  {y:A_j\vdash \tup z\share zt : B'_j\vlan\dotso\vlan B'_j}
		  {\vlin{}{}
			{(z_i:B'_j)_{i\leq n}\vdash \tup z:B'_j\vlan\dotso\vlan B'_j}
			{\vlhy{
				\Big(
					\raisebox{5pt}{$\vlinf{}{}{z_i:B'_j\vdash z_i:B'_j}{}$}
				\Big)_{i\leq n}}}
		  }
		  {\vlhy{}}
		  {\vlhy{y:A_j\vdash t:B_j}}
		}
		\right)_{j\leq m}
	}
\]

\noindent
Rule~\eqref{eqn:distributor elimination} (distributor elimination), before:
\[
\vliiinf{}{}
  {u\distr xy{\tup t\share*{\vv*z}y}:C}
  {\raisebox{-18pt}{$(x_i:\bigcap_{j\leq m}(A'_j\vlim B^i_j))_{i\leq n}\vdash u:C$}}
  {}
  {\left(
	\vlderivation{
	  \vliiin{}{}
		{y:A_j\vdash \tup t\share*{\vv*z}y:B^1_j\vlan\dotso\vlan B^n_j}
		{\vlin{}{}
		  {\vv*z:A_j\vdash\tup t:B^1_j\vlan\dotso\vlan B^n_j}
		  {\vlhy{(\vv*z_i:A_j\vdash t_i:B^i_j)_{i\leq n}}}
		}
		{\vlhy{}}
		{\vlin{}{}{y:A_j\vdash y:A_j}{}}
	}
   \right)_{j\leq m}
  }
\]

\noindent
Rule~\eqref{eqn:distributor elimination} (distributor elimination), after: for each $i\leq n$:
\[
\vlinf{}{}
  {\vdash\lambda y_i.t_i\share*{\vv*z_i}{y_i}:\bigcap_{j\leq m}(A'_j\vlim B^i_j)}
  {\left(
	\vlderivation{
	  \vlin{}{}
		{\vdash\lambda y_i.t_i\share*{\vv*z_i}{y_i}:A'_j\vlim B^i_j}
		{\vliiin{}{}
		  {y_i:A'_j\vdash t_i\share*{\vv*z_i}{y_i}:B^i_j}
		  {\vlhy{\vv*z_i:A_j\vdash t_i:B^i_j}}
		  {\vlhy{}}
		  {\vlin{}{}{y_i:A'_j\vdash y_i:A'_j}{}}
	}}
   \right)_{j\leq m}
  }
\]
%
Note that the type assignments $\vv*z_i:A_j$ and $y_i:A'_j$ may be combined in the above due to the fact that $A_j=A'_j$ or $\vv*z_i$ is empty.



\noindent
During reduction,
% in the typing derivations for $t^n$ in
%\[
%\vliiinf{}{}
%	{u\distr xy{t^n}:C}
%	{(x_i:\bigcap_{j\leq m}(A_j\vlim B^i_j))_{i\leq n}\vdash u:C}	
%	{\vlhy{}}
%	{(y:V_j\vdash t^n:B^1_j\vlan\dotso\vlan B^n_j)_{j\leq m}}
%\]
the following holds for the leading variables in the terms concerned:
\begin{itemize}

	\item
if a variable is weakened, it remains weakened;

	\item
if it is not, it may become weakened only through a beta-step in $t^n$;
 
	\item
if it becomes weakened, it may retain its previous type.

\end{itemize}

\end{proof}



\newpage

\noindent
\begin{ALlemma}
Reverse subject reduction for the distributor rewrite rules of $D_a$.
\end{ALlemma}

\begin{proof}
\noindent
Rule~\eqref{eqn:share abstraction} (distributor introduction), after:
\[
  \vliiinf{}{}
	{u\distr*{\vv*x}y{\tup z\share zt}:C}
	{\raisebox{-25pt}{
		$(x_i:\bigcap_{j\leq m}(A'_j\vlim B'_j))_{i\leq n}\vdash u:C$
	}}	
	{\vlhy{}}
	{\left(\vlderivation{
		\vliiin{}{}
	 	  {y:A_j\vdash \tup z\share zt : B'_j\vlan\dotso\vlan B'_j}
		  {\vlin{}{}
			{(z_i:B'_j)_{i\leq n}\vdash \tup z:B'_j\vlan\dotso\vlan B'_j}
			{\vlhy{
				\Big(
					\raisebox{5pt}{$\vlinf{}{}{z_i:B'_j\vdash z_i:B'_j}{}$}
				\Big)_{i\leq n}}}
		  }
		  {\vlhy{}}
		  {\vlhy{y:A_j\vdash t:B_j}}
		}
		\right)_{j\leq m}
	}
\]

% NOTE: Here we need the full definition of replacement types,
%       since the B'_j in the types for the x_i are intersections;
%       otherwise we must show we can adjust the type of the x_i
%
%Where $B_j=\bigcap_{i\leq p}B^i_j$ and $B'_j=\bigcap_{i\leq p}B'^i_j$ with each $B'^i_j$ a replacement type for $t:B^i_j$.
%%
%Then the statement $t:B_j$ must have been derived by:
%%
%\[
%  \vlinf{}{}
%    {y:A_j\vdash t:B_j}
%    {(y:A_j\vdash t:B^i_j)_{i\leq p}}
%\]


\noindent
Rule~\eqref{eqn:share abstraction} (distributor introduction), before, is as follows:
\[
\vlderivation{
  \vliiin{}{}
	{\vdash u\share*{\vv*x}{\lambda y.t}:C}
	{\vlhy{\vv*x:\bigcap_{j\leq m}(A'_j\vlim B'_j)\vdash u:C}}
	{\vlhy{}}
	{\vlin{}{}
	  {\vdash\lambda y.t:\bigcap_{j\leq m}(A_j\vlim B_j)}
	  {\vlhy{
	    \left(
		\vlinf{}{}
	 	  {\vdash\lambda y.t:A_j\vlim B_j}
		  {y:A_j\vdash t:B_j}
		\right)_{j\leq m}
	}}}
}
\]

%\[
%\vlderivation{
%  \vliiin{}{}
%	{\vdash u\share*{\vv*x}{\lambda y.t}:C}
%	{\vlhy{\vv*x:\bigcap^{i\leq n}_{j\leq m}(A'_j\vlim B'^i_j)\vdash u:C}}
%	{\vlhy{}}
%	{\vlin{}{}
%	  {\vdash\lambda y.t:\bigcap^{i\leq n}_{j\leq m}(A_j\vlim B_j)}
%	  {\vlhy{
%	    \left(
%		\vlinf{}{}
%	 	  {\vdash\lambda y.t:A_j\vlim B_j}
%		  {y:A_j\vdash t:B_j}
%		\right)_{\overset{\scriptstyle {i\leq n}}{j\leq m}}
%	}}}
%}
%\]


\bigskip

\noindent
Rule~\eqref{eqn:distributor elimination} (distributor elimination), after: consider the following term: $u\subn{x_i}{\lambda y_i.t_i\share*{\vv*z_i}{y_i}}$.
%
For $u$, by Proposition~\ref{prop:typing substitution} we get the typing statement below left, from which the one below right is derived using  and Proposition~\ref{prop:intersection weakening}. 

\[
\textstyle
	(x_i:B_i\vlim C_i)_{i\leq n}\vdash_D u:A
\quads3
	\vv*x:\bigcap_{j\leq n}(B_j\vlim C_j)\vdash_D u:A
\]
For $t_i$ we get:
\[
\vlderivation{
  \vlin{}{}
	{\vdash\lambda y_i.t_i\share*{\vv*z_i}{y_i}:B_i\vlim C_i}
	{\vliiin{}{}
	  {y:B_i\vdash t_i\share*{\vv*z_i}{y_i}\:C_i}
	  {\vlhy{\vv*z_i:B_i\vdash t_i:C_i}}
	  {\vlhy{}}
	  {\vlin{}{}{y:B_i\vdash y:B_i}{}}
}}
\]
%
Since all $t_j$ are variants, to obtain the desired typing for the tuple $\tup t$, we first replicate the typing derivations for a given $t_j$ (below left), after which a renaming of variables gives the desired typing derivation (below right).
\[
  \vlderivation{
	\vlin{}{}
		  {\vv*z^{\kern2pt i}:B_j\vdash\tup^{t_j}:C_j\vlan\dotso\vlan C_j}
		  {\vlhy{(\vv*z_j^{\kern2pt i}:B_j\vdash t_j^{\kern2pt i}:C_j)_{i\leq n}}}
		}
\qquad
  \vlderivation{
	\vlin{}{}
	  {\vv*z:B_j\vdash\tup t:C_j\vlan\dotso\vlan C_j}
	  {\vlhy{(\vv*z_i:B_j\vdash t_i:C_j)_{i\leq n}}}
	}
\]
Rule~\eqref{eqn:distributor elimination} (distributor elimination), before:
\[
\vliiinf{}{}
  {u\distr*{\vv*x}y{\tup t\share*{\vv*z}y}:A}
  {\raisebox{-10pt}{$\vv*x:\bigcap_{j\leq n}(B_j\vlim C_j)\vdash_D u:A$}}
  {}
  {\left(
	\vlderivation{
	  \vliiin{}{}
		{y:B_j\vdash \tup t\share*{\vv*z}y:C_j\vlan\dotso\vlan C_j}
		{\vlhy{\vv*z:B_j\vdash\tup t:C_j\vlan\dotso\vlan C_j}}
		{\vlhy{}}
		{\vlin{}{}{y:B_j\vdash y:B_j}{}}
	}
   \right)_{j\leq m}
 }
\]

\end{proof}

\newpage


\begin{ALlemma}
\label{lem:weakening SN}
If $(t)\overline w\in\SN$, then $\forall v\in\SN.~(t\share*{}v)\overline w\in\SN$.
\end{ALlemma}

\begin{ALlemma}
\label{lem:weakening RED}
If $(t)\overline w\in|B|$, then $\forall v\in\SN.~(t\share*{}v)\overline w\in|B|$.
\end{ALlemma}

\begin{proof}
The proof is by induction on $B$.
%
The case where $B$ is an atom is covered by Lemma~\ref{lem:weakening SN}; the case $B=C\cap D$ is immediate.
%
For $B=C\vlim D$, let $v\in\SN$. 
%
We have to show that $(t\share*{}v)\overline w\in|C\vlim D|$, i.e.\ that $(t\share*{}v)\overline ww\in |D|$ for all $w\in|C|$.
%
Let $w\in|C|$.
%
Because $(t)\overline w\in|C\vlim D|$, we have $(t)\overline ww\in|D|$, and by the induction hypothesis, $(t\share*{}v)\overline ww\in|D|$.
\end{proof}


\begin{ALlemma}
\label{lem:unfolding weakened variable}
If a variable $y$ occurs free and weakened in a term $t$ then the unfolding of $t$ is of the form $t'\share*{}y$.
\end{ALlemma}



\noindent{\color{red} To be inserted into the proof of `Proposition 23'}

\noindent{\color{red} Part (i)}

We distinguish two cases, depending on whether $y$ occurs weakened.

\medskip

\textbf{(i)} The variable $y$ occurs weakened.
%
In this case, $V_j=A_j$.

\noindent{\color{red} Part (ii)}

\medskip

\textbf{(ii)} The variable $y$ occurs weakened.
%
By the induction hypothesis, 
\[
	u'=u^n\subn[m][j]{z_j}{w_j}\in|B_j\vlan\dotso\vlan B_j|
\]
for each $j\leq m$, and therefore $\pi_i(u')\in|B_j|$, and $\sn(\pi_i(u'))\in|B_j|$.
%
Because $y$ is weakened, we have $\sn(\lambda y.\pi_i(u'))=\lambda y.u''\share*{}y$ with $u''=\sn(\pi_i(u'))$.
%
Since $u''\in|B_j|$, by Lemma~\ref{lem:weakening RED} we have $u''\share*{}v\in|B_j|$ for any $v\in\SN$.
%
Therefore $\lambda y.u''\share*{}y\in|V\vlim B_j|$ for any formula $V$, and in particular $\lambda y.u''\share*{}y\in|A_j\to B_j|$.
%
This means that $\sn(\lambda y.\pi_i(u'))$ is in $|\bigcap_{j\leq n}(A_j\vlim B_j)|$, as is any variant of it.
%
By the induction hypothesis, 
\[
	s'\subn{x_i}{\sn(\lambda y.\pi_i(u'))^i}\in|C|
\]
and by Lemma~\ref{lem:Red-AddSharings}
\[
	s'\subn{x_i}{\sn(\lambda y.\pi_i(u'))^i}[\sh(\lambda y.u^n)]\in|C|\;.
\]
It follows by Lemma~\ref{lem:IntCaseLambdaSharing} that $s'\distr xy{u'}\in|C|$.


\end{document}








